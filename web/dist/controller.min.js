/*!
 * projectmanager - compressed JS
 * @licence projectmanager - v1.0.0 (2016-09-08)
  */
angular.module("fileType",["fileType.controller"]),angular.module("fileType.controller",[]).controller("fileTypeController",["$scope","$stateParams","$mdDialog","uvTip","uvmAlert","fileTypeService",function(a,b,c,d,e,f){console.log(a.project),f.getAllFileType(b.project_id).then(function(b){a.file_types=b.data}),a.defFileType=function(b,e){c.show({templateUrl:"file_type_def_template",controller:"fileTypeDefController",targetEvent:b,clickOutsideToClose:!1,locals:{ft:e||{},project:a.project}}).then(function(b){b&&d.showTip((e?"修改":"添加")+"文件类型成功",1e3).then(function(){a.reloadState()})})}}]).controller("fileTypeDefController",["$scope","$mdDialog","uvDialog","uvTip","fileTypeService","ft","project",function(a,b,c,d,e,f,g){a.ft=f,a.project=g,a.cancel=function(){b.hide()},a.confirm=function(){e.saveOrUpdateFileType(g.project_id,a.ft).then(function(a){console.log(a),a&&0==a.ret_code?b.hide(!0):c.show("操作失败,"+a.ret_msg)})},a.folderChange=function(b){if(b){var c=b.trim();"/"!=c&&c&&("/"!=c.charAt(0)&&(c="/"+c),"/"==c.charAt(c.length-1)&&(c=c.substr(0,c.length-1))),a.ft.ft_folder=c}}}]),angular.module("file",["file.controller"]),angular.module("file.controller",["ngFileUpload"]).controller("filesController",["$scope","$mdDialog","uvmAlert","uvTip","$stateParams","fileService","fileTypeService",function(a,b,c,d,e,f,g){function h(c,d){return b.show({templateUrl:"def_file_template",targetEvent:c,locals:{file:d||{},project:a.project},controller:"fileDefController"})}f.getAllFiles(e.project_id).then(function(b){a.files=b.data}),g.getAllFileType(e.project_id).then(function(b){a.file_types=b.data,a.ftIDs=[],a.ftJSON={},angular.forEach(a.file_types,function(b){this.push(b.ft_id),a.ftJSON[b.ft_id]=b},a.ftIDs),a.selectedFTIDs=angular.copy(a.ftIDs)}).then(function(){a.toggle=function(b){var c=a.selectedFTIDs.indexOf(b);c>-1?a.selectedFTIDs.splice(c,1):a.selectedFTIDs.push(b)},a.isExists=function(b){return a.selectedFTIDs.indexOf(b)>-1},a.toggleAll=function(){a.selectedFTIDs.length<a.ftIDs.length?a.selectedFTIDs=a.ftIDs.slice(0):a.selectedFTIDs=[]},a.isChecked=function(){return a.selectedFTIDs.length===a.ftIDs.length},a.isIndeterminate=function(){return a.selectedFTIDs.length>0&&a.selectedFTIDs.length<a.ftIDs.length}}),a.addFile=function(b){h(b).then(function(b){b&&a.reloadState()})},a.showFileHis=function(c,d){b.show({templateUrl:"file_his_template",targetEvent:c,locals:{file:d,ftJSON:a.ftJSON},resolve:{files:["fileService",function(a){return a.getFileHis(d.file_id).then(function(a){return a.data})}]},controller:"fileHisController"})},a.orderFiles=function(b){a.orderKey==b?a.orderReverse=!a.orderReverse:(a.orderKey=b,a.orderReverse=!1)},a.orderKey="file_path_name",a.orderReverse=!1}]).controller("fileDefController",["$scope","$mdDialog","Upload","uvTip","uvDialog","uvmAlert","fileService","fileTypeService","file","project",function(a,b,c,d,e,f,g,h,i,j){function k(b){angular.forEach(b,function(b){if(a.filesJSON[b.name]){delete a.filesJSON[b.name];var c=a.files.indexOf(b);c>-1&&a.files.splice(c,1,b)}else a.files.push(b);a.filesJSON[b.name]=b,g.getFile(j.project_id,a.ft.ft_id,a.folder||"",b.name).then(function(a){a&&0==a.ret_code&&(b.curr_version=a.data?a.data.curr_version:"无")})})}a.file=i,a.project=j,a.cancel=function(){b.hide()},a.loadFileType=function(){return h.getAllFileType(j.project_id).then(function(b){a.file_types=b.data})},a.confirm=function(){return a.ft?a.files&&0!=a.files.length?(a.uploading=!0,a.percent=0,void c.upload({url:"project/"+j.project_id+"/file",data:{file:a.files,folder:a.folder||"",ft_id:a.ft.ft_id}}).then(function(c){a.uploading=!1;var f=c.data;f&&0==f.ret_code?(angular.forEach(f.data,function(a){this[a.file_name].version=a.curr_version},a.filesJSON),d.showTip("上传成功!").then(function(){b.hide(!0)})):e.show("上传失败,"+f.ret_msg)},function(b){console.log("Error status: "+b.status),console.log(b),e.show("上传失败,"+b),a.uploading=!1},function(b){a.percent=parseInt(100*b.loaded/b.total)})):void d.showTip("请选择文件",1e3):void d.showTip("请选择文件类型",1e3)},a.folderChange=function(){a.folder&&a.folder.length>0&&("/"!=a.folder.charAt(0)&&(a.folder="/"+a.folder),"/"==a.folder.charAt(a.folder.length-1)&&(a.folder=a.folder.substr(0,a.folder.length-1))),k(a.files)},a.$watch("ft",function(){k(a.files)}),a.addFile=function(b){return a.ft?(a.files||(a.files=[]),a.filesJSON||(a.filesJSON={}),void k(b)):void d.showTip("请先选择文件类型")},a.delFile=function(b){if(b instanceof File){var c=a.files.indexOf(b);c>-1&&a.files.splice(c,1),delete a.filesJSON[b.name]}}}]).controller("fileHisController",["$scope","file","ftJSON","files","$mdDialog",function(a,b,c,d,e){a.file=b,a.ftJSON=c,a.files=d,a.cancel=function(){e.hide()}}]),angular.module("main",["main.controller"]),angular.module("main.controller",[]).controller("mainController",["$rootScope","$scope","$state","$timeout","$mdDialog","$templateCache","uvmAlert","userService",function(a,b,c,d,e,f,g,h){function i(a,c){for(var d=a,e=a.root_distance;e>=c&&d.root_distance!=c;e--)d=b.treeJSON[a.pid];return d}console.log("main.controller"),h.currentUser().then(function(a){b.currentLoginUser=a.data}),b.fb={isOpen:!0},d(function(){b.fb.isOpen=!1},100),b.logout=function(){g.confirm("确定退出系统?").then(function(){window.location="logout"},function(){console.log("取消退出系统")})},b.modifyPassword=function(a){e.show({controller:"modifyPwdController",templateUrl:"modify_password_template.html",parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!1,resolve:{currentUser:function(){return h.currentUser().then(function(a){return a&&a.data?a.data:void g.alert("未知用户信息,请先退出系统,重新登录!").then(function(){window.location.href="login"})})}}}).then(function(a){a&&g.alert("修改密码成功,请重新登录!").then(function(){window.location.href="logout"})})},b.$watch("currentStateName",function(a){a&&(b.currentState=b.treeStateJSON[a],console.log(b.currentState),"main"==a.toString()||(b.currentState.root_distance>=1&&(b.currentStateTop=i(b.currentState,1)),b.currentState.root_distance>=2?b.currentStateLeft=i(b.currentState,2):b.currentStateLeft={}))})}]).controller("modifyPwdController",["$scope","$mdDialog","userService","currentUser",function(a,b,c,d){a.currentUser=d,a.cancel=function(){b.hide(!1)},a.confirm=function(){return a.pwdForm.$invalid?void console.log("form valid failure"):void c.modifyCurrentUserPassword({current_password:a.curr_password,new_password:a.new_password}).then(function(a){a&&0==a.ret_code?b.hide(!0):uvmAlert.alert(a.ret_msg)})}}]),angular.module("moduleFileUpdate",["mfu"]),angular.module("mfu",["mfu.controller"]),angular.module("mfu.controller",["ngFileUpload"]).controller("moduleFileUpdateController",["$scope","$timeout","$filter","$mdSidenav","Upload","$mdDialog","$stateParams","uvTip","uvDialog","uvmAlert","uvTree","fileTypeService","fileService","funcService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){b(function(){a.funcList=[],n.getAllFuncs(g.project_id).then(function(b){a.funcList=b.data,a.funcJSON={},angular.forEach(a.funcList,function(b){a.funcJSON[b.func_id]=b})}),l.getAllFileType(g.project_id).then(function(b){a.file_types=b.data,a.ftIDs=[],a.ftJSON={},angular.forEach(a.file_types,function(b){this.push(b.ft_id),a.ftJSON[b.ft_id]=b},a.ftIDs),a.selectedFTIDs=angular.copy(a.ftIDs)}).then(function(){a.toggle=function(b){var c=a.selectedFTIDs.indexOf(b);c>-1?a.selectedFTIDs.splice(c,1):a.selectedFTIDs.push(b)},a.isExists=function(b){return a.selectedFTIDs.indexOf(b)>-1},a.toggleAll=function(){a.selectedFTIDs.length<a.ftIDs.length?a.selectedFTIDs=a.ftIDs.slice(0):a.selectedFTIDs=[]},a.isChecked=function(){return a.selectedFTIDs.length===a.ftIDs.length},a.isIndeterminate=function(){return a.selectedFTIDs.length>0&&a.selectedFTIDs.length<a.ftIDs.length}}),m.getAllFiles(g.project_id).then(function(b){a.allFiles=b.data,a.ftFiles={},angular.forEach(a.allFiles,function(a){this[a.ft_id]||(this[a.ft_id]=[]),this[a.ft_id].push(a)},a.ftFiles)})}),a.treeName="defaultTree",a.defFunc=function(b){a.editFunc=angular.copy(b)||{},a.editFunc.files||a.editFunc.func_id&&n.getFuncFiles(a.editFunc.func_id).then(function(b){a.editFunc.files=b.data,a.editFunc.filesJSON={},angular.forEach(b.data,function(b){a.editFunc.filesJSON[b.ff_id]=b})}),d("func_def_sidenav").open()},a.exitFunc=function(){d("func_def_sidenav").close(),delete a.editFunc},a.downloadFunc=function(){var b=k.getTree(a.treeName).getSelected();if(!b||0==b.length)return void h.showTip("请用复选框选择要下载的模块!",2e3);var c=[];angular.forEach(b,function(a){this.push(a.func_id)},c),window.open("func/dl?fid="+c.join(","))},a.downCurrFunc=function(){window.open("func/dl?fid="+a.editFunc.func_id)},a.updateFile=function(b){var c=a.editFunc.files;angular.forEach(b,function(b,d){for(var e=0;e<c.length;e++){var f=a.ftJSON[c[e].ft_id].ft_folder+c[e].file_path_name;"//"==f.substr(0,2)&&(f=f.substr(1)),(f==(b.path||b.name)||f.indexOf(b.path||b.name)>-1&&0==f.split(b.path||b.name)[1].length)&&(c[e].isUpdate=1,c[e].file=b,c[e].uploadFlag=0)}})},a.cancelSingleUpload=function(a){delete a.isUpdate,delete a.file,delete a.uploadFlag},a.cancelAllUpload=function(){angular.forEach(a.editFunc.files,function(a){delete a.isUpdate,delete a.file,delete a.uploadFlag})},a.uploadFile=function(b,c){console.log("uploadFile,"+arguments[2]),c.uploadFlag=1,a.uploadingFilesID.push(c.ff_id),e.upload({url:"project/"+a.project.project_id+"/func/"+b+"/upd-file/"+c.ff_id,data:{file:c.file,file_id:c.file_id}}).then(function(a){var b=a.data;b&&0==b.ret_code?(c.uploadFlag=2,c.curr_version=b.data.curr_version,c.version=b.data.curr_version):(i.show("上传["+c.file_path_name+"]失败,"+b.ret_msg),c.uploadFlag=3)},function(a){console.log("Error status: "+a.status),console.log(a),c.uploadFlag=3,i.show("上传["+c.file_path_name+"]失败,error status:"+a.status)},function(a){c.percentage=parseInt(100*a.loaded/a.total)})["finally"](function(){console.log("finally"),a.uploadingFilesID.splice(a.uploadingFilesID.indexOf(c.ff_id),1),c.isUpdate=2})},a.uploadingFilesID=[],a.uploadingCount=1,a.uploadAllFiles=function(){var b=0,c=function(){if(b<a.editFunc.files.length){if(a.uploadingFilesID.length>=a.uploadingCount)return void setTimeout(c,200);for(var d=b;d<a.editFunc.files.length;d++){var e=a.editFunc.files[d];if(1==e.isUpdate&&1!=e.uploadFlag||2==e.isUpdate&&3==e.uploadFlag){b=d+1,console.log("upload "+e.file_path_name),a.uploadFile(a.editFunc.func_id,e,"from all"),c();break}}}};c()}}]),angular.module("module",["module.controller"]),angular.module("module.controller",[]).controller("moduleController",["$scope","$timeout","$filter","$mdSidenav","$mdDialog","$stateParams","uvTip","uvDialog","uvmAlert","uvTree","fileTypeService","fileService","funcService",function(a,b,c,d,e,f,g,h,i,j,k,l,m){b(function(){a.funcList=[],m.getAllFuncs(f.project_id).then(function(b){a.funcList=b.data,a.funcJSON={},angular.forEach(a.funcList,function(b){a.funcJSON[b.func_id]=b})}),k.getAllFileType(f.project_id).then(function(b){a.file_types=b.data,a.ftIDs=[],a.ftJSON={},angular.forEach(a.file_types,function(b){this.push(b.ft_id),a.ftJSON[b.ft_id]=b},a.ftIDs),a.selectedFTIDs=angular.copy(a.ftIDs)}).then(function(){a.toggle=function(b){var c=a.selectedFTIDs.indexOf(b);c>-1?a.selectedFTIDs.splice(c,1):a.selectedFTIDs.push(b)},a.isExists=function(b){return a.selectedFTIDs.indexOf(b)>-1},a.toggleAll=function(){a.selectedFTIDs.length<a.ftIDs.length?a.selectedFTIDs=a.ftIDs.slice(0):a.selectedFTIDs=[]},a.isChecked=function(){return a.selectedFTIDs.length===a.ftIDs.length},a.isIndeterminate=function(){return a.selectedFTIDs.length>0&&a.selectedFTIDs.length<a.ftIDs.length}}),l.getAllFiles(f.project_id).then(function(b){a.allFiles=b.data,a.ftFiles={},angular.forEach(a.allFiles,function(a){this[a.ft_id]||(this[a.ft_id]=[]),this[a.ft_id].push(a)},a.ftFiles)})}),a.treeName="defaultTree",a.defFunc=function(b){a.editFunc=angular.copy(b)||{},a.editFunc.ftFiles||(a.editFunc.ftFiles={},a.editFunc.func_id?m.getFuncFiles(a.editFunc.func_id).then(function(b){angular.forEach(b.data,function(b){a.editFunc.ftFiles[b.ft_id]||(a.editFunc.ftFiles[b.ft_id]=[]),a.editFunc.ftFiles[b.ft_id].push(b)}),angular.forEach(a.ftIDs,function(b){a.editFunc.ftFiles[b]||(a.editFunc.ftFiles[b]=[])})}):(a.editFunc.ftFiles={},angular.forEach(a.ftIDs,function(b){a.editFunc.ftFiles[""+b]=[]}))),d("func_def_sidenav").open()},a.exitFunc=function(){d("func_def_sidenav").close(),delete a.editFunc},a.selectFunc=function(b){e.show({templateUrl:"select_func_template",clickOutsideToClose:!1,escapeToClose:!1,controller:"selectFuncController",locals:{selectedFuncID:b,funcs:angular.copy(a.funcList)}}).then(function(b){if(b)if(a.editFunc.func_id==b.func_id)i.alert("上级模块不可选择自己!");else{for(var c=b;-1!=c.par_func_id;){if(c.par_func_id==a.editFunc.func_id){i.alert("上级模块不可选择本模块的子模块!");break}c=a.funcJSON[c.par_func_id]}a.editFunc.par_func_id=b.func_id}})},a.searchFuncFiles=function(a,b){if(!a||0==a.length)return[];var d=c("filter")(a,{file_path_name:b});return d},a.saveFunc=function(){m.saveFunc(f.project_id,a.editFunc).then(function(b){if(b&&0==b.ret_code){g.showTip("保存成功!",2e3).then(function(){a.exitFunc()});var c=b.data;if(a.funcJSON[c.func_id]){a.funcJSON[c.func_id]=c;for(var d=0;d<a.funcList.length;d++)if(a.funcList[d].func_id==c.func_id){a.funcList[d]=c;break}}else a.funcJSON[c.func_id]=c,a.funcList.push(c)}else i.alert("保存失败,"+b.ret_msg)})},a.downloadFunc=function(){var b=j.getTree(a.treeName).getSelected();if(!b||0==b.length)return void g.showTip("请用复选框选择要下载的模块!",2e3);var c=[];angular.forEach(b,function(a){this.push(a.func_id)},c),window.open("func/dl?fid="+c.join(","))},a.defBug=function(b){a.editBug=b,d("bug_def_sidenav").open()},a.exitBug=function(){d("bug_def_sidenav").close(),delete a.editBug}}]).controller("selectFuncController",["$scope","selectedFuncID","funcs","$mdDialog","uvTree",function(a,b,c,d,e){var f=a.parFuncSelectTreeName="_funcsTree_";a.funcs=c,angular.forEach(c,function(a){a.func_id==b&&(a.selected=!0)}),a.cancel=function(){d.hide()},a.confirm=function(){var a=e.getTree(f).getSelected();d.hide(a)}}]),angular.module("project",["project.controller"]),angular.module("project.controller",[]).controller("projectListController",["$scope","$http","$mdDialog","uvmAlert","projectService",function(a,b,c,d,e){e.getAllProject().then(function(b){a.projects=b.data}),a.addProject=function(b){c.show({controller:"addProjectController",templateUrl:"project_add_template",targetEvent:b,clickOutsideToClose:!1}).then(function(b){b&&d.alert("添加项目成功").then(function(){a.reloadState()})})}}]).controller("addProjectController",["$scope","$mdDialog","projectService","uvDialog",function(a,b,c,d){a.cancel=function(){b.hide()},a.confirm=function(){var e={project_name:a.project_name,project_desc:a.project_desc};c.addProject(e).then(function(a){a&&0==a.ret_code?b.hide(!0):d.show("添加失败,"+a.ret_msg)})}}]).controller("projectDetailController",["$scope","uvmAlert","$stateParams","$state","projectService",function(a,b,c,d,e){e.getProject(c).then(function(c){c.data||b.alert("项目不存在").then(function(){d.go("project.list")}),a.project=c.data})}]);